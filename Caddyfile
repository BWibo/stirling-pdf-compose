# Stirling PDF Reverse Proxy Configuration
# Configured for devleco.dom.local/pdf subpath

devleco.dom.local {
	# Enable HTTPS with automatic certificate management
	# Remove this line if you want to use HTTP only (not recommended)
	# tls your-email@example.com

	# Handle /pdf subpath
	handle_path /pdf* {
		# Increase timeouts for PDF processing operations
		# This allows for longer processing times on large PDFs
		@timeout {
			path /*
		}

		# Request body size limit for large PDF uploads (500MB)
		# Matches SYSTEM_MAXFILESIZE: "500" in docker-compose.proxy.yml
		request_body {
			max_size 500MB
		}

		# Reverse proxy to Stirling PDF container
		reverse_proxy stirling-pdf:8080 {
			# Increase timeouts for large file processing
			transport http {
				# Dial timeout - time to establish connection
				dial_timeout 30s

				# Response header timeout - time to receive response headers
				response_header_timeout 300s

				# Read timeout - time to read entire response
				read_timeout 600s

				# Write timeout - time to write request
				write_timeout 600s
			}

			# Flush interval for streaming responses
			flush_interval -1

			# Health check configuration (matches subpath)
			health_uri /pdf/api/v1/info/status
			health_interval 30s
			health_timeout 10s
			health_status 200
		}

		# Security headers
		header {
			# Remove server identification
			-Server

			# XSS Protection
			X-Content-Type-Options "nosniff"
			X-Frame-Options "SAMEORIGIN"
			X-XSS-Protection "1; mode=block"

			# Referrer Policy
			Referrer-Policy "strict-origin-when-cross-origin"
		}

		# Enable compression for better performance
		encode gzip zstd
	}

	# Logging for the entire site
	log {
		output file /var/log/caddy/stirling-pdf-access.log {
			roll_size 100mb
			roll_keep 10
		}
		format json
	}
}

# Alternative configuration for localhost/IP access (HTTP only)
# Uncomment this block if you want to access via localhost or IP
# :8081 {
#     request_body {
#         max_size 500MB
#     }
#
#     reverse_proxy stirling-pdf:8080 {
#         transport http {
#             dial_timeout 30s
#             response_header_timeout 300s
#             read_timeout 600s
#             write_timeout 600s
#         }
#         flush_interval -1
#     }
#
#     encode gzip zstd
# }
